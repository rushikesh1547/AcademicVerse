
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Verifies that a document exists before an update or delete operation.
     * Prevents operations on non-existent documents.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Combines ownership and existence checks for update/delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    /**
     * Checks if the owner of a parent Quiz document matches the requesting user.
     * Assumes the parent quiz has a 'teacherId' field.
     */
    function isQuizOwner(quizId) {
      let quiz = get(/databases/$(database)/documents/quizzes/$(quizId));
      return isSignedIn() && quiz != null && quiz.data.teacherId == request.auth.uid;
    }
    
    /**
     * Checks if the owner of a parent Assignment document matches the requesting user.
     * Assumes the parent assignment has a 'teacherId' field.
     */
    function isAssignmentOwner(assignmentId) {
      let assignment = get(/databases/$(database)/documents/assignments/$(assignmentId));
      return isSignedIn() && assignment != null && assignment.data.teacherId == request.auth.uid;
    }
    
    /**
     * Checks if the owner of a parent Attendance Session document matches the requesting user.
     * Assumes the parent session has a 'teacherId' field.
     */
    function isSessionOwner(sessionId) {
      let session = get(/databases/$(database)/documents/attendanceSessions/$(sessionId));
      return isSignedIn() && session != null && session.data.teacherId == request.auth.uid;
    }

    // --------------------------------
    // User & Profile Rules
    // --------------------------------

    /**
     * @description Users can create and manage their own user document. Listing users is disallowed.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.authenticationUid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Student profiles are read-only for the owning user. Creation and modification are disabled for clients.
     * @path /students/{studentId}
     */
    match /students/{studentId} {
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Teacher profiles are read-only for the owning user. Creation and modification are disabled for clients.
     * @path /teachers/{teacherId}
     */
    match /teachers/{teacherId} {
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // --------------------------------
    // Attendance Rules
    // --------------------------------

    /**
     * @description Attendance session info is readable by any signed-in user.
     * @path /attendanceSessions/{sessionId}
     */
    match /attendanceSessions/{sessionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isSessionOwner(sessionId);
    }

    /**
     * @description Attendance interval data is written by the backend. Readable by the relevant student or the session's teacher.
     * @path /attendanceSessions/{sessionId}/attendanceIntervals/{intervalId}
     */
    match /attendanceSessions/{sessionId}/attendanceIntervals/{intervalId} {
      allow get: if isSignedIn() && (isSessionOwner(sessionId) || resource.data.studentId == request.auth.uid);
      allow list: if isSessionOwner(sessionId) || isSignedIn();
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update, delete: if isExistingDoc() && resource.data.studentId == request.auth.uid;
    }

    /**
     * @description Attendance summary data is written by the backend. Readable by the relevant student or the session's teacher.
     * @path /attendanceSessions/{sessionId}/attendanceSummary/{summaryId}
     */
    match /attendanceSessions/{sessionId}/attendanceSummary/{summaryId} {
      allow get: if isSignedIn() && (isSessionOwner(sessionId) || resource.data.studentId == request.auth.uid);
      allow list: if isSessionOwner(sessionId);
      allow create, update, delete: if false;
    }

    // --------------------------------
    // Academic Content Rules
    // --------------------------------

    /**
     * @description Quizzes are readable by any authenticated user. Only the creating teacher can write.
     * @path /quizzes/{quizId}
     */
    match /quizzes/{quizId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.teacherId == request.auth.uid;
    }

    /**
     * @description Quiz questions are readable by any user, but only manageable by the quiz owner.
     * @path /quizzes/{quizId}/quizQuestions/{questionId}
     */
    match /quizzes/{quizId}/quizQuestions/{questionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isQuizOwner(quizId);
    }

    /**
     * @description Students can create and manage their own quiz attempts. The quiz owner can read/list attempts for grading.
     * @path /quizzes/{quizId}/quizAttempts/{attemptId}
     */
    match /quizzes/{quizId}/quizAttempts/{attemptId} {
      allow get: if (isExistingDoc() && resource.data.studentId == request.auth.uid) || isQuizOwner(quizId);
      allow list: if isQuizOwner(quizId);
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update, delete: if isExistingDoc() && resource.data.studentId == request.auth.uid;
    }

    /**
     * @description Assignments are readable by any authenticated user. Only the creating teacher can write.
     * @path /assignments/{assignmentId}
     */
    match /assignments/{assignmentId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.teacherId == request.auth.uid;
    }

    /**
     * @description Secure rule for Collection Group queries on 'assignmentSubmissions'.
     * @path /{path=**}/assignmentSubmissions/{submissionId}
     */
    match /{path=**}/assignmentSubmissions/{submissionId} {
      // This rule enables collection group queries by students (on their studentId)
      // and teachers (on their teacherId).
      allow list: if isSignedIn() && (request.auth.uid == resource.data.studentId || request.auth.uid == resource.data.teacherId);
    }

    /**
     * @description Manages direct access to assignment submissions.
     * @path /assignments/{assignmentId}/assignmentSubmissions/{submissionId}
     */
    match /assignments/{assignmentId}/assignmentSubmissions/{submissionId} {
      // Allow teacher to list all submissions for their own assignment.
      allow list: if isAssignmentOwner(assignmentId);
      
      // Allow read if user is the student who submitted or the teacher who owns the assignment.
      allow get: if isAssignmentOwner(assignmentId) || (isExistingDoc() && resource.data.studentId == request.auth.uid);
      
      // Allow create if the user is the student and the teacherId on the submission matches the parent assignment's teacherId.
      allow create: if isSignedIn() 
                      && request.resource.data.studentId == request.auth.uid
                      && request.resource.data.teacherId == get(/databases/$(database)/documents/assignments/$(assignmentId)).data.teacherId;

      // Allow update if user is the student (resubmitting) or the teacher (evaluating).
      allow update: if isExistingDoc() && (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);

      // Allow delete only by the student who created it.
      allow delete: if isExistingDoc() && resource.data.studentId == request.auth.uid;
    }

    /**
     * @description Resources are readable by any authenticated user. Only the uploading teacher can write.
     * @path /resources/{resourceId}
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.uploaderId == request.auth.uid;
      allow update, delete: if isExistingDoc() && resource.data.uploaderId == request.auth.uid;
    }

    // --------------------------------
    // Student-Owned Document Rules
    // --------------------------------

    /**
     * @description Students can create and manage their own exam forms. Teachers can list them for approval.
     * @path /examForms/{formId}
     */
    match /examForms/{formId} {
      allow get: if (isExistingDoc() && resource.data.studentId == request.auth.uid) || isSignedIn(); // Allow teachers to get too
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if isExistingDoc() && resource.data.studentId == request.auth.uid;
      allow delete: if isExistingDoc() && resource.data.studentId == request.auth.uid;
    }

    /**
     * @description Users can only access results within their own user space.
     * @path /users/{userId}/results/{resultId}
     */
    match /users/{userId}/results/{resultId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Users can only access grade cards within their own user space.
     * @path /users/{userId}/gradeCards/{gradeCardId}
     */
    match /users/{userId}/gradeCards/{gradeCardId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Users can only access notifications within their own user space.
     * @path /users/{userId}/notifications/{notificationId}
     */
    match /users/{userId}/notifications/{notificationId} {
      allow read, write: if isOwner(userId);
    }
  }
}
