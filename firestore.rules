
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Verifies that a document exists before an update or delete operation.
     * Prevents operations on non-existent documents.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Combines ownership and existence checks for update/delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    /**
     * Checks if the owner of a parent Quiz document matches the requesting user.
     * Assumes the parent quiz has a 'teacherId' field.
     */
    function isQuizOwner(quizId) {
      let quiz = get(/databases/$(database)/documents/quizzes/$(quizId));
      return isSignedIn() && quiz != null && quiz.data.teacherId == request.auth.uid;
    }
    
    /**
     * Checks if the owner of a parent Assignment document matches the requesting user.
     * Assumes the parent assignment has a 'teacherId' field.
     */
    function isAssignmentOwner(assignmentId) {
      let assignment = get(/databases/$(database)/documents/assignments/$(assignmentId));
      return isSignedIn() && assignment != null && assignment.data.teacherId == request.auth.uid;
    }
    
    /**
     * Checks if the owner of a parent Attendance Session document matches the requesting user.
     * Assumes the parent session has a 'teacherId' field.
     */
    function isSessionOwner(sessionId) {
      let session = get(/databases/$(database)/documents/attendanceSessions/$(sessionId));
      return isSignedIn() && session != null && session.data.teacherId == request.auth.uid;
    }

    /**
     * Checks if the requesting user has the 'teacher' role.
     * Prioritizes the role from the user document, but falls back to checking
     * the email format to handle race conditions during user creation.
     */
    function isTeacher() {
      if (!isSignedIn()) {
        return false;
      }
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (userDoc != null) {
        return userDoc.data.role == 'teacher';
      }
      // Fallback for user creation race condition
      return request.auth.token.email != null && request.auth.token.email.matches('.*@teacher\\.com$');
    }

    /**
     * Checks if the requesting user has the 'admin' role.
     * Prioritizes the role from the user document, but falls back to checking
     * the email to handle race conditions during user creation.
     */
    function isAdmin() {
      if (!isSignedIn()) {
        return false;
      }
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (userDoc != null) {
        return userDoc.data.role == 'admin';
      }
      // Fallback for user creation race condition
      return request.auth.token.email == 'user@admin.com';
    }

    // --------------------------------
    // User & Profile Rules
    // --------------------------------

    /**
     * @description Users can create and manage their own user document. Listing users is allowed for teachers and admins.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isTeacher() || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.authenticationUid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Student profiles are read-only for the owning user. Creation and modification are disabled for clients.
     * @path /students/{studentId}
     */
    match /students/{studentId} {
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Teacher profiles are read-only for the owning user. Creation and modification are disabled for clients.
     * @path /teachers/{teacherId}
     */
    match /teachers/{teacherId} {
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // --------------------------------
    // Attendance Rules
    // --------------------------------

    /**
     * @description Attendance session info is readable by any signed-in user. Only the creating teacher can manage sessions.
     * @path /attendanceSessions/{sessionId}
     */
    match /attendanceSessions/{sessionId} {
      allow get, list: if isSignedIn();
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow update: if isSessionOwner(sessionId) && request.resource.data.keys().hasOnly(['presentStudentIds']);
      allow delete: if isSessionOwner(sessionId);
    }

    /**
     * @description Attendance intervals can only be created/managed by the session owner (teacher). Students can read their own records.
     * @path /attendanceSessions/{sessionId}/attendanceIntervals/{intervalId}
     */
    match /attendanceSessions/{sessionId}/attendanceIntervals/{intervalId} {
      allow get: if isSignedIn() && (isSessionOwner(sessionId) || (isExistingDoc() && resource.data.studentId == request.auth.uid));
      allow list: if isSessionOwner(sessionId);
      allow create, update, delete: if isSessionOwner(sessionId);
    }

    /**
     * @description Attendance summary data is written by the backend. Readable by the relevant student or the session's teacher.
     * @path /attendanceSessions/{sessionId}/attendanceSummary/{summaryId}
     */
    match /attendanceSessions/{sessionId}/attendanceSummary/{summaryId} {
      allow get: if isSignedIn() && (isSessionOwner(sessionId) || (isExistingDoc() && resource.data.studentId == request.auth.uid));
      allow list: if isSessionOwner(sessionId);
      allow create, update, delete: if false; // Only backend/functions can write summaries
    }

    // --------------------------------
    // Academic Content Rules
    // --------------------------------

    /**
     * @description Lesson plans are readable by any authenticated user. Only the creating teacher can write.
     * @path /lessonPlans/{lessonPlanId}
     */
    match /lessonPlans/{lessonPlanId} {
      allow get, list: if isSignedIn();
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isExistingDoc() && resource.data.teacherId == request.auth.uid;
    }

    /**
     * @description Quizzes are readable by any authenticated user. Only the creating teacher can write.
     * @path /quizzes/{quizId}
     */
    match /quizzes/{quizId} {
      allow get, list: if isSignedIn();
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isQuizOwner(quizId);
    }

    /**
     * @description Quiz questions are readable by any user, but only manageable by the quiz owner.
     * @path /quizzes/{quizId}/quizQuestions/{questionId}
     */
    match /quizzes/{quizId}/quizQuestions/{questionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isQuizOwner(quizId);
    }

    /**
     * @description Students can create and manage their own quiz attempts. The quiz owner can read/list attempts for grading.
     * @path /quizzes/{quizId}/quizAttempts/{attemptId}
     */
    match /quizzes/{quizId}/quizAttempts/{attemptId} {
      allow get: if (isExistingDoc() && resource.data.studentId == request.auth.uid) || isQuizOwner(quizId);
      allow list: if isQuizOwner(quizId);
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update, delete: if isExistingDoc() && resource.data.studentId == request.auth.uid;
    }

    /**
     * @description Assignments are readable by any authenticated user. Only the creating teacher can write.
     * @path /assignments/{assignmentId}
     */
    match /assignments/{assignmentId} {
      allow get, list: if isSignedIn();
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAssignmentOwner(assignmentId);
    }

    /**
     * @description Manages direct access to assignment submissions.
     * @path /assignments/{assignmentId}/assignmentSubmissions/{submissionId}
     */
    match /assignments/{assignmentId}/assignmentSubmissions/{submissionId} {
      allow list: if isAssignmentOwner(assignmentId);
      allow get: if isAssignmentOwner(assignmentId) || (isExistingDoc() && resource.data.studentId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid && request.resource.data.teacherId == get(/databases/$(database)/documents/assignments/$(assignmentId)).data.teacherId;
      allow update: if isExistingDoc() && (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);
      allow delete: if isExistingDoc() && resource.data.studentId == request.auth.uid;
    }

    /**
     * @description Resources are readable by any authenticated user. Only the uploading teacher can write.
     * @path /resources/{resourceId}
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isTeacher() && request.resource.data.uploaderId == request.auth.uid;
      allow update, delete: if isExistingDoc() && resource.data.uploaderId == request.auth.uid;
    }

    // --------------------------------
    // Collection Group Query Rules
    // --------------------------------

    /**
     * @description Secure rule for Collection Group queries on 'assignmentSubmissions'.
     * @path /{path=**}/assignmentSubmissions/{submissionId}
     */
    match /{path=**}/assignmentSubmissions/{submissionId} {
      // Students can query their own submissions across all assignments.
      // Teachers can query submissions they are the teacher for.
      allow list: if isSignedIn() && (request.query.where[0][2] == request.auth.uid);
    }

    /**
     * @description Collection group query for teachers to list all exam forms.
     * @path /{path=**}/examForms/{formId}
     */
    match /{path=**}/examForms/{formId} {
      allow list: if isTeacher() || isAdmin();
    }
    
    // --------------------------------
    // Student-Owned Document Rules
    // --------------------------------
    
    /**
     * @description Users can only access results within their own user space.
     * @path /users/{userId}/results/{resultId}
     */
    match /users/{userId}/results/{resultId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Users can only access grade cards within their own user space.
     * @path /users/{userId}/gradeCards/{gradeCardId}
     */
    match /users/{userId}/gradeCards/{gradeCardId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Hall tickets are created by teachers, but owned and read by students.
     * @path /users/{userId}/hallTickets/{hallTicketId}
     */
    match /users/{userId}/hallTickets/{hallTicketId} {
      // Students can read their own hall tickets.
      allow get, list: if isOwner(userId);
      // Teachers can create (upload) hall tickets for any student.
      allow create: if isTeacher();
      // No one can update or delete from the client.
      allow update, delete: if false;
    }

    /**
     * @description Students own their exam forms. Teachers can update status.
     * @path /users/{userId}/examForms/{formId}
     */
    match /users/{userId}/examForms/{formId} {
      allow get, list, create: if isOwner(userId);
      allow update: if isTeacher() && request.resource.data.keys().hasOnly(['approvalStatus']);
      allow delete: if isOwner(userId) && resource.data.approvalStatus == 'Pending';
    }
    
    /**
     * @description Users can only access notifications within their own user space.
     * @path /users/{userId}/notifications/{notificationId}
     */
    match /users/{userId}/notifications/{notificationId} {
      allow read, write: if isOwner(userId);
    }
  }
}

    
